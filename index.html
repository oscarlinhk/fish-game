<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­šè¦èŸ¹ Pro - è·¨è£ç½®ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #d32f2f; --green: #388e3c; --blue: #1976d2; --gold: #fbc02d; }
        body { font-family: -apple-system, sans-serif; background: #f0f0f0; margin: 0; text-align: center; }
        .view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .view.active { display: flex; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 20px 40px; margin: 10px; font-size: 20px; border: none; border-radius: 12px; cursor: pointer; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--red); color: white; }

        /* iPad æ£‹ç›¤ */
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 600px; }
        .cell { background: white; padding: 20px 5px; border-radius: 15px; position: relative; border: 3px solid transparent; }
        .cell.active { border-color: var(--gold); background: #fffde7; }
        .cell .icon { font-size: 50px; display: block; }
        .chip-count { position: absolute; top: -5px; right: -5px; background: var(--gold); border-radius: 50%; width: 30px; height: 30px; line-height: 30px; font-weight: bold; font-size: 14px; }

        /* éª°å­ */
        .dice-container { display: flex; gap: 15px; margin: 20px 0; }
        .die { width: 70px; height: 70px; background: white; border-radius: 12px; font-size: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }

        /* æ‰‹æ©Ÿæ§åˆ¶ */
        .shaker-btn { width: 180px; height: 180px; background: var(--red); color: white; border-radius: 50%; font-size: 24px; border: 5px solid white; box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        input { padding: 15px; font-size: 18px; width: 80%; max-width: 300px; text-align: center; border-radius: 8px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="view-start" class="view active">
        <h1>é­šè¦èŸ¹éŠæˆ²</h1>
        <button class="btn" onclick="startAsHost()">æˆ‘æ˜¯ iPad (é¡¯ç¤ºæ£‹ç›¤)</button>
        <button class="btn" onclick="startAsController()">æˆ‘æ˜¯ æ‰‹æ©Ÿ (ç•¶æ–ç›…)</button>
    </div>

    <div id="view-host" class="view">
        <div style="background:#333; color:white; padding:10px 20px; border-radius:20px; margin-bottom:10px;">
            é€£ç·šç¢¼: <b id="peer-id">å–å¾—ä¸­...</b>
        </div>
        <div id="host-msg">ç­‰å¾…æ‰‹æ©Ÿé€£ç·š...</div>
        <div class="dice-container">
            <div id="d1" class="die">?</div><div id="d2" class="die">?</div><div id="d3" class="die">?</div>
        </div>
        <div class="board" id="game-board"></div>
        <h2 style="color:var(--red)">é¤˜é¡: $<span id="balance">1000</span></h2>
    </div>

    <div id="view-controller" class="view">
        <div id="ctrl-setup">
            <h2>é€£æ¥åˆ° iPad</h2>
            <input type="number" id="join-id" placeholder="è¼¸å…¥ 4 ä½é€£ç·šç¢¼" pattern="\d*">
            <br><br>
            <button class="btn btn-primary" onclick="connectToHost()">ç¢ºèªé€£ç·š</button>
        </div>
        <div id="ctrl-active" style="display:none;">
            <div style="margin-bottom:30px;">å·²æˆåŠŸé€£ç·š</div>
            <button class="shaker-btn" id="shake-btn">æŒ‰æˆ‘æˆ–æ–å‹•é–‹éª°ï¼</button>
        </div>
    </div>

<script>
    // éŒ¯èª¤æ•ç²
    window.onerror = (m, u, l) => alert(`Error: ${m} at line ${l}`);

    const symbols = [
        { name: 'é­š', icon: 'ğŸŸ', color: 'red' }, { name: 'è¦', icon: 'ğŸ¦', color: 'green' },
        { name: 'è‘«è˜†', icon: 'ğŸ¶', color: 'blue' }, { name: 'é‡‘éŒ¢', icon: 'ğŸ’°', color: 'blue' },
        { name: 'èŸ¹', icon: 'ğŸ¦€', color: 'green' }, { name: 'é›', icon: 'ğŸ“', color: 'red' }
    ];

    let peer, conn, balance = 1000, bets = [0,0,0,0,0,0];

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- iPad é‚è¼¯ ---
    function startAsHost() {
        showView('view-host');
        const board = document.getElementById('game-board');
        symbols.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'cell';
            div.innerHTML = `<span class="icon">${s.icon}</span><b>${s.name}</b><div class="chip-count" id="c-${i}" style="display:none">0</div>`;
            div.onclick = () => {
                if (balance >= 100) { balance -= 100; bets[i] += 100; updateUI(); }
            };
            board.appendChild(div);
        });

        const shortId = Math.floor(1000 + Math.random() * 9000);
        peer = new Peer('fpc-' + shortId);
        peer.on('open', id => document.getElementById('peer-id').innerText = id.replace('fpc-', ''));
        peer.on('connection', c => {
            conn = c;
            document.getElementById('host-msg').innerText = "âœ… æ‰‹æ©Ÿå·²é€£ç·šï¼";
            conn.on('data', data => { if(data === 'ROLL') performRoll(); });
        });
    }

    function updateUI() {
        document.getElementById('balance').innerText = balance;
        bets.forEach((amt, i) => {
            const el = document.getElementById(`c-${i}`);
            el.innerText = amt;
            el.style.display = amt > 0 ? 'block' : 'none';
            el.parentElement.classList.toggle('active', amt > 0);
        });
    }

    function performRoll() {
        if (bets.reduce((a, b) => a + b, 0) === 0) return;
        const dice = [document.getElementById('d1'), document.getElementById('d2'), document.getElementById('d3')];
        dice.forEach(d => d.classList.add('rolling'));
        
        setTimeout(() => {
            const res = [Math.floor(Math.random()*6), Math.floor(Math.random()*6), Math.floor(Math.random()*6)];
            dice.forEach((d, i) => {
                d.classList.remove('rolling');
                d.innerText = symbols[res[i]].icon;
            });
            calculateWin(res);
        }, 1200);
    }

    function calculateWin(results) {
        let win = 0, back = 0;
        bets.forEach((bet, i) => {
            const matches = results.filter(r => r === i).length;
            if (matches > 0) { win += bet * matches; back += bet; }
        });
        balance += (win + back);
        bets = [0,0,0,0,0,0];
        setTimeout(() => { updateUI(); if(win>0) alert(`è´äº† $${win}ï¼`); }, 500);
    }

    // --- æ‰‹æ©Ÿé‚è¼¯ ---
    function startAsController() {
        showView('view-controller');
    }

    async function connectToHost() {
        const id = document.getElementById('join-id').value;
        if (!id) return;

        // è«‹æ±‚æ„Ÿæ‡‰å™¨æ¬Šé™ (iOS å¿…å‚™)
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            await DeviceMotionEvent.requestPermission();
        }

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('fpc-' + id);
            conn.on('open', () => {
                document.getElementById('ctrl-setup').style.display = 'none';
                document.getElementById('ctrl-active').style.display = 'block';
                
                const btn = document.getElementById('shake-btn');
                const trigger = () => { conn.send('ROLL'); btn.style.opacity = '0.5'; setTimeout(()=>btn.style.opacity='1', 500); };
                btn.onclick = trigger;

                window.addEventListener('devicemotion', e => {
                    let acc = e.accelerationIncludingGravity;
                    if (Math.abs(acc.x) + Math.abs(acc.y) > 30) trigger();
                });
            });
        });
    }
</script>
</body>
</html>
