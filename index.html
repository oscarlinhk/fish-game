<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­šè¦èŸ¹ v4.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #d32f2f; --green: #388e3c; --blue: #1976d2; --gold: #fbc02d; }
        body { font-family: sans-serif; background: #f0f0f0; margin: 0; text-align: center; }
        .view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        /* å¼·åˆ¶é¡¯ç¤ºç›®å‰çš„é é¢ */
        .active { display: flex !important; }
        
        .btn { 
            padding: 25px 50px; margin: 15px; font-size: 22px; font-weight: bold;
            border: none; border-radius: 15px; cursor: pointer; 
            background: #ffffff; box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
            transition: 0.2s; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); background: #eee; }
        .btn-red { background: var(--red); color: white; }

        /* æ£‹ç›¤èˆ‡éª°å­ */
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90%; max-width: 500px; }
        .cell { background: white; padding: 20px 5px; border-radius: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cell .icon { font-size: 50px; display: block; }
        .chip { position: absolute; top: -5px; right: -5px; background: var(--gold); border-radius: 50%; width: 25px; height: 25px; line-height: 25px; font-size: 12px; font-weight: bold; }
        .dice-box { display: flex; gap: 15px; margin: 20px; }
        .die { width: 65px; height: 65px; background: white; border-radius: 12px; font-size: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        
        #version-tag { position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #aaa; }
    </style>
</head>
<body>

    <div id="version-tag">Version: 4.0 (Ultimate Fix)</div>

    <div id="view-start" class="view active">
        <h1 style="margin-bottom:0;">ğŸ² é­šè¦èŸ¹éŠæˆ²</h1>
        <p style="color: #666;">è«‹é¸æ“‡æ­¤è£ç½®çš„è§’è‰²</p>
        <button class="btn" onclick="startAsHost()">æˆ‘æ˜¯ iPad (é¡¯ç¤ºæ£‹ç›¤)</button>
        <button class="btn" onclick="startAsController()">æˆ‘æ˜¯ æ‰‹æ©Ÿ (ç•¶æ–ç›…)</button>
    </div>

    <div id="view-host" class="view">
        <div style="background:#333; color:white; padding:10px 25px; border-radius:30px; font-size:20px;">
            é€£ç·šç¢¼: <b id="peer-id" style="color:var(--gold)">ç”Ÿæˆä¸­...</b>
        </div>
        <p id="host-msg">ç­‰å¾…æ‰‹æ©Ÿé€£ç·š...</p>
        <div class="dice-box">
            <div id="d1" class="die">?</div><div id="d2" class="die">?</div><div id="d3" class="die">?</div>
        </div>
        <div class="board" id="main-board"></div>
        <h2 style="color:var(--red); margin: 20px 0;">é¤˜é¡: $<span id="balance">1000</span></h2>
        <button onclick="location.reload()" style="background:none; border:none; color:#999; text-decoration:underline;">é‡æ–°æ•´ç†</button>
    </div>

    <div id="view-controller" class="view">
        <div id="ctrl-setup">
            <h2>é€£æ¥åˆ° iPad</h2>
            <p>è«‹è¼¸å…¥ iPad ä¸Šé¡¯ç¤ºçš„ 4 ä½æ•¸å­—</p>
            <input type="number" id="join-id" placeholder="0000" style="padding:15px; font-size:30px; width:150px; text-align:center; border-radius:10px; border:2px solid #ddd;">
            <br><br>
            <button class="btn btn-red" onclick="connectToHost()">ç¢ºèªé€£ç·š</button>
            <br>
            <button onclick="location.reload()" style="background:none; border:none; color:#999;">è¿”å›é¦–é </button>
        </div>
        <div id="ctrl-active" style="display:none;">
            <h2 style="color:green">é€£ç·šæˆåŠŸ âœ…</h2>
            <button class="btn btn-red" id="shake-btn" style="width:220px; height:220px; border-radius:50%; font-size:28px; box-shadow: 0 10px 20px rgba(211,47,47,0.4);">
                æŒ‰æˆ‘é–‹éª°ï¼
            </button>
            <p style="margin-top:20px; color:#666;">æˆ–ç”¨åŠ›æ–æ™ƒæ‰‹æ©Ÿé–‹éª°</p>
        </div>
    </div>

<script>
    // ç¢ºä¿ script åœ¨é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
    window.onload = function() {
        console.log("é é¢å·²å®Œå…¨è¼‰å…¥ v4.0");
    };

    const symbols = [
        { name: 'é­š', icon: 'ğŸŸ', color: 'red' }, { name: 'è¦', icon: 'ğŸ¦', color: 'green' },
        { name: 'è‘«è˜†', icon: 'ğŸ¶', color: 'blue' }, { name: 'é‡‘éŒ¢', icon: 'ğŸ’°', color: 'blue' },
        { name: 'èŸ¹', icon: 'ğŸ¦€', color: 'green' }, { name: 'é›', icon: 'ğŸ“', color: 'red' }
    ];

    let peer, conn, balance = 1000, bets = [0,0,0,0,0,0];

    // åˆ‡æ›è¦–åœ–
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active');
    }

    // iPad é‚è¼¯
    function startAsHost() {
        showView('view-host');
        initBoard();
        const shortId = Math.floor(1000 + Math.random() * 9000);
        peer = new Peer('fpc-' + shortId);
        peer.on('open', id => document.getElementById('peer-id').innerText = id.replace('fpc-', ''));
        peer.on('connection', c => {
            conn = c;
            document.getElementById('host-msg').innerText = "âœ… æ‰‹æ©Ÿå·²é€£ç·šï¼Œè«‹é–‹å§‹ä¸‹æ³¨ï¼";
            conn.on('data', data => { if(data === 'ROLL') performRoll(); });
        });
    }

    function initBoard() {
        const board = document.getElementById('main-board');
        board.innerHTML = '';
        symbols.forEach((s
