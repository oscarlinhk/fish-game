<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­šè¦èŸ¹ Pro - è·¨è£ç½®ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #d32f2f; --green: #388e3c; --blue: #1976d2; --gold: #fbc02d; }
        body { font-family: sans-serif; background: #eee; margin: 0; text-align: center; overflow: hidden; }
        
        /* ä»‹é¢åˆ‡æ› */
        .view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* iPad æŠ•æ³¨ç›¤æ¨£å¼ */
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90vw; max-width: 800px; }
        .cell { background: white; padding: 30px 10px; border-radius: 15px; position: relative; border: 4px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cell.active { border-color: var(--gold); background: #fffde7; }
        .cell .icon { font-size: 60px; display: block; }
        .chip-count { position: absolute; top: -10px; right: -10px; background: var(--gold); border-radius: 50%; width: 35px; height: 35px; line-height: 35px; font-weight: bold; }

        /* éª°å­æ¨£å¼ */
        .dice-container { display: flex; gap: 20px; margin: 20px; }
        .die { width: 80px; height: 80px; background: white; border-radius: 15px; font-size: 50px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }

        /* æ‰‹æ©Ÿæ§åˆ¶ç«¯æ¨£å¼ */
        .shaker-btn { width: 200px; height: 200px; background: var(--red); color: white; border-radius: 50%; font-size: 30px; font-weight: bold; border: 8px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.3); cursor: pointer; }
        .shaker-btn:active { transform: scale(0.95); }

        .status-tag { padding: 10px 20px; background: #333; color: white; border-radius: 20px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="view-start" class="view active">
        <h1>è«‹é¸æ“‡è£ç½®é¡å‹</h1>
        <button onclick="startAsHost()" style="padding:20px; margin:10px; font-size:20px;">æˆ‘æ˜¯ iPad (é¡¯ç¤ºæ£‹ç›¤)</button>
        <button onclick="startAsController()" style="padding:20px; margin:10px; font-size:20px;">æˆ‘æ˜¯ æ‰‹æ©Ÿ (ç•¶æ–ç›…)</button>
    </div>

    <div id="view-host" class="view">
        <div class="status-tag">é€£ç·šç¢¼: <span id="peer-id">æ­£åœ¨å–å¾—...</span></div>
        <div id="host-msg">ç­‰å¾…æ‰‹æ©Ÿé€£ç·š...</div>
        <div class="dice-container" id="host-dice">
            <div class="die">?</div><div class="die">?</div><div class="die">?</div>
        </div>
        <div class="board" id="game-board"></div>
        <h2 style="color:var(--red)">é¤˜é¡: $<span id="balance">1000</span></h2>
    </div>

    <div id="view-controller" class="view">
        <div id="ctrl-setup">
            <input type="text" id="join-id" placeholder="è¼¸å…¥ iPad é¡¯ç¤ºçš„é€£ç·šç¢¼" style="padding:15px; font-size:20px; text-align:center;">
            <br><br>
            <button onclick="connectToHost()" style="padding:15px 30px;">é€£ç·š</button>
        </div>
        <div id="ctrl-active" style="display:none;">
            <div class="status-tag">å·²é€£ç·šåˆ° iPad</div>
            <button class="shaker-btn" id="shake-btn">ç”¨åŠ›æ–æˆ–æŒ‰æˆ‘ï¼</button>
            <p>æç¤ºï¼šæ–å‹•æ‰‹æ©Ÿä¹Ÿèƒ½é–‹éª°å–”ï¼</p>
        </div>
    </div>

<script>
    const symbols = [
        { name: 'é­š', icon: 'ğŸŸ', color: 'red' }, { name: 'è¦', icon: 'ğŸ¦', color: 'green' },
        { name: 'è‘«è˜†', icon: 'ğŸ¶', color: 'blue' }, { name: 'é‡‘éŒ¢', icon: 'ğŸ’°', color: 'blue' },
        { name: 'èŸ¹', icon: 'ğŸ¦€', color: 'green' }, { name: 'é›', icon: 'ğŸ“', color: 'red' }
    ];

    let peer, conn;
    let balance = 1000;
    let bets = [0, 0, 0, 0, 0, 0];

    // --- åˆå§‹åŒ– iPad æ£‹ç›¤ ---
    function initBoard() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        symbols.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'cell';
            div.innerHTML = `<span class="icon">${s.icon}</span><b>${s.name}</b><div class="chip-count" id="c-${i}" style="display:none">0</div>`;
            div.onclick = () => {
                if (balance >= 100) {
                    balance -= 100;
                    bets[i] += 100;
                    updateUI();
                }
            };
            board.appendChild(div);
        });
    }

    function updateUI() {
        document.getElementById('balance').innerText = balance;
        bets.forEach((amt, i) => {
            const el = document.getElementById(`c-${i}`);
            el.innerText = amt;
            el.style.display = amt > 0 ? 'block' : 'none';
            el.parentElement.classList.toggle('active', amt > 0);
        });
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šé€£ç·š ---
    function startAsHost() {
        showView('view-host');
        initBoard();
        // ç”¢ç”Ÿä¸€å€‹ç°¡å–®çš„ ID
        const shortId = Math.floor(1000 + Math.random() * 9000);
        peer = new Peer('fpc-' + shortId);
        
        peer.on('open', id => document.getElementById('peer-id').innerText = id.replace('fpc-', ''));
        peer.on('connection', c => {
            conn = c;
            document.getElementById('host-msg').innerText = "âœ… æ‰‹æ©Ÿå·²é€£ç·šï¼å¯ä»¥é–‹å§‹ä¸‹æ³¨åŠæ–éª°";
            conn.on('data', data => { if(data === 'ROLL') performRoll(); });
        });
    }

    function startAsController() {
        showView('view-controller');
    }

    function connectToHost() {
        const id = document.getElementById('join-id').value;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('fpc-' + id);
            conn.on('open', () => {
                document.getElementById('ctrl-setup').style.display = 'none';
                document.getElementById('ctrl-active').style.display = 'block';
                initShakeDetection();
            });
        });
    }

    // --- æ–éª°å‹•ç•«èˆ‡çµç®— ---
    function performRoll() {
        if (bets.reduce((a, b) => a + b, 0) === 0) return;
        
        const diceDivs = document.querySelectorAll('.die');
        diceDivs.forEach(d => d.classList.add('rolling'));

        setTimeout(() => {
            const results = [rand(), rand(), rand()];
            diceDivs.forEach((d, i) => {
                d.classList.remove('rolling');
                d.innerText = symbols[results[i]].icon;
                d.style.color = `var(--${symbols[results[results[i]].color})`;
            });
            calculateWin(results);
        }, 1500);
    }

    function calculateWin(results) {
        let win = 0;
        let back = 0;
        bets.forEach((bet, i) => {
            const matches = results.filter(r => r === i).length;
            if (matches > 0) {
                win += bet * matches;
                back += bet;
            }
        });
        balance += (win + back);
        bets = [0, 0, 0, 0, 0, 0];
        setTimeout(() => { updateUI(); alert(win > 0 ? `è´äº† $${win}ï¼` : "æ²’ä¸­çï¼Œå†æ¥å†å²ï¼"); }, 500);
    }

    const rand = () => Math.floor(Math.random() * 6);

    // --- æ‰‹æ©Ÿæ–æ™ƒæ„Ÿæ‡‰ ---
    function initShakeDetection() {
        const btn = document.getElementById('shake-btn');
        const trigger = () => { conn.send('ROLL'); btn.style.background = '#ffc107'; setTimeout(()=>btn.style.background='#d32f2f', 500); };
        
        btn.onclick = trigger;

        // æ–æ™ƒåµæ¸¬ (iOS éœ€è¦ https æ‰èƒ½é‹ä½œï¼Œä¸”éœ€ç”¨æˆ¶æˆæ¬Š)
        let lastX, lastY, lastZ;
        window.addEventListener('devicemotion', e => {
            let acc = e.accelerationIncludingGravity;
            let change = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY);
            if (change > 30) trigger(); 
            lastX = acc.x; lastY = acc.y; lastZ = acc.z;
        });
    }

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>