<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­šè¦èŸ¹ Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #d32f2f; --green: #388e3c; --blue: #1976d2; --gold: #fbc02d; }
        body { font-family: -apple-system, sans-serif; background: #1a1a1a; color: white; margin: 0; text-align: center; }
        .view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .view.active { display: flex; }
        
        .btn { padding: 18px 35px; margin: 10px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; background: #fff; color: #333; font-weight: bold; width: 220px; }
        .btn-primary { background: var(--red); color: white; }
        .btn:disabled { background: #666; cursor: not-allowed; }

        /* iPad æ£‹ç›¤ */
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 600px; }
        .cell { background: white; color: #333; padding: 20px 5px; border-radius: 15px; position: relative; border: 3px solid transparent; }
        .cell.active { border-color: var(--gold); background: #fffde7; }
        .cell .icon { font-size: 45px; display: block; }
        .chip-count { position: absolute; top: -5px; right: -5px; background: var(--gold); border-radius: 50%; width: 30px; height: 30px; line-height: 30px; font-weight: bold; color: black; }

        /* éª°å­ */
        .dice-container { display: flex; gap: 15px; margin: 20px 0; }
        .die { width: 70px; height: 70px; background: white; color: #333; border-radius: 12px; font-size: 40px; display: flex; align-items: center; justify-content: center; }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }

        /* æ‰‹æ©Ÿæ§åˆ¶ */
        .shaker-btn { width: 200px; height: 200px; background: var(--red); color: white; border-radius: 50%; font-size: 24px; border: 8px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.5); font-weight: bold; }
        input { padding: 15px; font-size: 24px; width: 200px; text-align: center; border-radius: 10px; border: none; margin-bottom: 20px; }
        #debug-log { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #0f0; font-size: 10px; text-align: left; padding: 5px; max-height: 60px; overflow-y: auto; pointer-events: none; }
    </style>
</head>
<body>

    <div id="view-start" class="view active">
        <h2>è«‹é¸æ“‡è£ç½®é¡å‹</h2>
        <button class="btn" onclick="startAsHost()">æˆ‘æ˜¯ iPad (æ¡Œä¸»)</button>
        <button class="btn" onclick="startAsController()">æˆ‘æ˜¯ æ‰‹æ©Ÿ (æ–ç›…)</button>
    </div>

    <div id="view-host" class="view">
        <div style="background:var(--gold); color:black; padding:10px 30px; border-radius:30px; margin-bottom:15px; font-weight:bold;">
            é€£ç·šç¢¼: <span id="peer-id" style="font-size:24px;">å–å¾—ä¸­...</span>
        </div>
        <div id="host-msg">âŒ› æ­£åœ¨ç­‰å¾…æ‰‹æ©Ÿé€£ç·š...</div>
        <div class="dice-container">
            <div id="d1" class="die">?</div><div id="d2" class="die">?</div><div id="d3" class="die">?</div>
        </div>
        <div class="board" id="game-board"></div>
        <h2 style="color:var(--gold)">é¤˜é¡: $<span id="balance">1000</span></h2>
    </div>

    <div id="view-controller" class="view">
        <div id="ctrl-setup">
            <h2>è¼¸å…¥ iPad ä¸Šçš„é€£ç·šç¢¼</h2>
            <input type="number" id="join-id" placeholder="0000" inputmode="numeric">
            <br>
            <button class="btn btn-primary" id="connect-btn" onclick="connectToHost()">ç¢ºèªé€£ç·š</button>
            <button class="btn" onclick="location.reload()" style="background:transparent; color:white; border:1px solid #666; font-size:14px; width:auto; padding:10px;">è¿”å›é‡æ–°é–‹å§‹</button>
        </div>
        <div id="ctrl-active" style="display:none;">
            <div style="margin-bottom:40px; color:var(--green); font-weight:bold;">âœ… å·²é€£ç·šæˆåŠŸï¼</div>
            <button class="shaker-btn" id="shake-btn">ç”¨åŠ›æ–æˆ–æŒ‰æˆ‘ï¼</button>
            <p style="margin-top:20px; opacity:0.7;">æç¤ºï¼šä¸‹æ³¨å®Œå¾Œå†æ–å‹•</p>
        </div>
    </div>

    <div id="debug-log">ç³»çµ±æ—¥èªŒæº–å‚™å°±ç·’...</div>

<script>
    function log(msg) {
        console.log(msg);
        const logEl = document.getElementById('debug-log');
        logEl.innerHTML += `<div>> ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    const symbols = [
        { name: 'é­š', icon: 'ğŸŸ' }, { name: 'è¦', icon: 'ğŸ¦' },
        { name: 'è‘«è˜†', icon: 'ğŸ¶' }, { name: 'é‡‘éŒ¢', icon: 'ğŸ’°' },
        { name: 'èŸ¹', icon: 'ğŸ¦€' }, { name: 'é›', icon: 'ğŸ“' }
    ];

    let peer, conn, balance = 1000, bets = [0,0,0,0,0,0];

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- iPad é‚è¼¯ ---
    function startAsHost() {
        showView('view-host');
        initBoard();
        const shortId = Math.floor(1000 + Math.random() * 9000);
        log(`æ­£åœ¨å»ºç«‹ä¸»æ©Ÿï¼ŒID: ${shortId}`);
        
        peer = new Peer('fpc-' + shortId);
        
        peer.on('open', id => {
            document.getElementById('peer-id').innerText = id.replace('fpc-', '');
            log("ä¸»æ©Ÿå·²åœ¨ç·šï¼Œç­‰å¾…é€£ç·š...");
        });

        peer.on('connection', c => {
            conn = c;
            log("æ‰‹æ©Ÿå·²é€£å…¥ï¼");
            document.getElementById('host-msg').innerHTML = "âœ… <span style='color:#4caf50'>æ‰‹æ©Ÿå·²é€£ç·šï¼è«‹åœ¨ iPad ä¸‹æ³¨ä¸¦ç”¨æ‰‹æ©Ÿé–‹éª°</span>";
            conn.on('data', data => { if(data === 'ROLL') performRoll(); });
        });

        peer.on('error', err => log(`éŒ¯èª¤: ${err.type}`));
    }

    function initBoard() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        symbols.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'cell';
            div.innerHTML = `<span class="icon">${s.icon}</span><b>${s.name}</b><div class="chip-count" id="c-${i}" style="display:none">0</div>`;
            div.onclick = () => { if (balance >= 100) { balance -= 100; bets[i] += 100; updateUI(); } };
            board.appendChild(div);
        });
    }

    function updateUI() {
        document.getElementById('balance').innerText = balance;
        bets.forEach((amt, i) => {
            const el = document.getElementById(`c-${i}`);
            el.innerText = amt;
            el.style.display = amt > 0 ? 'block' : 'none';
            el.parentElement.classList.toggle('active', amt > 0);
        });
    }

    function performRoll() {
        if (bets.reduce((a, b) => a + b, 0) === 0) return log("æœªä¸‹æ³¨ï¼Œæ‹’çµ•é–‹éª°");
        log("æ”¶åˆ°æ–éª°æŒ‡ä»¤ï¼");
        const dice = [document.getElementById('d1'), document.getElementById('d2'), document.getElementById('d3')];
        dice.forEach(d => d.classList.add('rolling'));
        
        setTimeout(() => {
            const res = [Math.floor(Math.random()*6), Math.floor(Math.random()*6), Math.floor(Math.random()*6)];
            dice.forEach((d, i) => {
                d.classList.remove('rolling');
                d.innerText = symbols[res[i]].icon;
            });
            calculateWin(res);
        }, 1200);
    }

    function calculateWin(results) {
        let win = 0, back = 0;
        bets.forEach((bet, i) => {
            const matches = results.filter(r => r === i).length;
            if (matches > 0) { win += bet * matches; back += bet; }
        });
        balance += (win + back);
        bets = [0,0,0,0,0,0];
        setTimeout(() => { updateUI(); if(win>0) alert(`è´äº† $${win}ï¼`); }, 500);
    }

    // --- æ‰‹æ©Ÿé‚è¼¯ ---
    function startAsController() {
        showView('view-controller');
        log("åˆ‡æ›åˆ°æ‰‹æ©Ÿæ¨¡å¼");
    }

    async function connectToHost() {
        const inputId = document.getElementById('join-id').value;
        if (!inputId) return alert("è«‹è¼¸å…¥é€£ç·šç¢¼");

        const connectBtn = document.getElementById('connect-btn');
        connectBtn.disabled = true;
        connectBtn.innerText = "é€£ç·šä¸­...";
        log(`å˜—è©¦é€£ç·šåˆ°ä¸»æ©Ÿ: ${inputId}`);

        // iOS æ–æ™ƒæ¬Šé™
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try { await DeviceMotionEvent.requestPermission(); } catch(e) { log("æ¬Šé™è¢«æ‹’çµ•"); }
        }

        if (peer) peer.destroy(); // ç¢ºä¿èˆŠé€£ç·šå·²æ¸…é™¤
        peer = new Peer();
        
        peer.on('open', () => {
            conn = peer.connect('fpc-' + inputId);
            
            // è¨­ç½®è¶…æ™‚æª¢æ¸¬
            const timeout = setTimeout(() => {
                if (!conn.open) {
                    log("é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥é€£ç·šç¢¼æ˜¯å¦æ­£ç¢º");
                    connectBtn.disabled = false;
                    connectBtn.innerText = "é‡è©¦é€£ç·š";
                }
            }, 8000);

            conn.on('open', () => {
                clearTimeout(timeout);
                log("æˆåŠŸé€£æ¥åˆ° iPadï¼");
                document.getElementById('ctrl-setup').style.display = 'none';
                document.getElementById('ctrl-active').style.display = 'block';
                setupShaker();
            });

            conn.on('error', err => {
                log(`é€£ç·šå‡ºéŒ¯: ${err}`);
                connectBtn.disabled = false;
                connectBtn.innerText = "ç¢ºèªé€£ç·š";
            });
        });
    }

    function setupShaker() {
        const btn = document.getElementById('shake-btn');
        let canRoll = true;
        const trigger = () => {
            if (!canRoll) return;
            conn.send('ROLL');
            log("ç™¼é€é–‹éª°æŒ‡ä»¤");
            btn.style.transform = "scale(0.9)";
            canRoll = false;
            setTimeout(() => { btn.style.transform = "scale(1)"; canRoll = true; }, 2000);
        };
        btn.onclick = trigger;

        window.addEventListener('devicemotion', e => {
            let acc = e.accelerationIncludingGravity;
            if (Math.abs(acc.x) + Math.abs(acc.y) > 25) trigger();
        });
    }
</script>
</body>
</html>
