<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­šè¦èŸ¹ DEBUGç‰ˆ v6.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #222; color: white; text-align: center; }
        .view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex !important; }
        
        .btn { padding: 20px 40px; margin: 10px; font-size: 20px; cursor: pointer; border-radius: 10px; border: none; background: white; color: black; font-weight: bold; }
        .btn:active { background: #ccc; }

        /* è³­æª¯ä½ˆå±€ */
        .table { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90%; max-width: 600px; }
        .cell { background: #006400; border: 2px solid white; padding: 20px 5px; border-radius: 10px; position: relative; }
        .cell .icon { font-size: 40px; display: block; }
        .chip { position: absolute; top: -5px; right: -5px; background: gold; color: black; border-radius: 50%; width: 25px; height: 25px; line-height: 25px; font-size: 12px; font-weight: bold; }

        /* é™¤éŒ¯è¦–çª— */
        #debug-log { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); color: #0f0; font-size: 12px; text-align: left; overflow-y: auto; padding: 5px; pointer-events: none; border-top: 1px solid #444; }
    </style>
</head>
<body>

    <div id="debug-log">ç³»çµ±æ—¥èªŒï¼šç­‰å¾…æ“ä½œ...<br></div>

    <div id="view-start" class="view active">
        <h1>ğŸ² é­šè¦èŸ¹ DEBUG v6.0</h1>
        <p>å¦‚æœé»æŒ‰éˆ•æ²’åæ‡‰ï¼Œè«‹æª¢æŸ¥ä¸‹æ–¹æ—¥èªŒ</p>
        <button class="btn" onclick="goToHost()">æˆ‘æ˜¯ iPad (é¡¯ç¤ºæ£‹ç›¤)</button>
        <button class="btn" onclick="goToController()">æˆ‘æ˜¯ æ‰‹æ©Ÿ (ç•¶æ–ç›…)</button>
    </div>

    <div id="view-host" class="view">
        <div style="margin-bottom:10px;">é€£ç·šç¢¼: <b id="peer-id" style="color:gold">ç­‰å¾…ç”Ÿæˆ...</b></div>
        <div id="host-msg">ç‹€æ…‹: æº–å‚™ä¸­</div>
        <div id="dice-area" style="font-size:40px; margin: 15px;">? ? ?</div>
        <div class="table" id="main-board"></div>
        <h2 id="balance-txt">é¤˜é¡: $5000</h2>
        <button onclick="location.reload()" style="color:white; background:none; border:1px solid #555;">é‡æ–°æ•´ç†</button>
    </div>

    <div id="view-controller" class="view">
        <input type="number" id="join-id" placeholder="è¼¸å…¥4ä½ç¢¼" style="padding:15px; font-size:20px; width:150px; text-align:center;">
        <br>
        <button class="btn" onclick="doConnect()">ç¢ºèªé€£ç·š</button>
        <div id="ctrl-active" style="display:none;">
            <button class="btn" style="background:red; color:white; width:150px; height:150px; border-radius:50%;" onclick="sendRoll()">æ–éª°ï¼</button>
        </div>
        <br>
        <button onclick="location.reload()" style="color:white; background:none; border:1px solid #555;">è¿”å›</button>
    </div>

<script>
    // --- æ—¥èªŒå·¥å…· ---
    function log(msg) {
        const el = document.getElementById('debug-log');
        el.innerHTML += "> " + msg + "<br>";
        el.scrollTop = el.scrollHeight;
        console.log(msg);
    }

    // --- æ›é é‚è¼¯ (ä¿è­‰å„ªå…ˆåŸ·è¡Œ) ---
    function showView(id) {
        log("å˜—è©¦åˆ‡æ›åˆ°: " + id);
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(id);
        if (target) {
            target.classList.add('active');
            log("åˆ‡æ›æˆåŠŸ");
        } else {
            log("éŒ¯èª¤: æ‰¾ä¸åˆ° ID " + id);
        }
    }

    // --- å…¨åŸŸè®Šæ•¸ ---
    const symbols = [{n:'é­š',i:'ğŸŸ'},{n:'è¦',i:'ğŸ¦'},{n:'è‘«è˜†',i:'ğŸ¶'},{n:'é‡‘éŒ¢',i:'ğŸ’°'},{n:'èŸ¹',i:'ğŸ¦€'},{n:'é›',i:'ğŸ“'}];
    let balance = 5000, bets = [0,0,0,0,0,0], peer, conn;

    // --- æŒ‰éˆ•é»æ“Šäº‹ä»¶ ---
    function goToHost() {
        log("é»æ“Šäº† iPad æŒ‰éˆ•");
        showView('view-host');
        initBoard();
        setupPeer();
    }

    function goToController() {
        log("é»æ“Šäº†æ‰‹æ©ŸæŒ‰éˆ•");
        showView('view-controller');
    }

    // --- iPad éŠæˆ²é‚è¼¯ ---
    function initBoard() {
        const board = document.getElementById('main-board');
        board.innerHTML = '';
        symbols.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'cell';
            div.innerHTML = `<span class="icon">${s.i}</span><b>${s.n}</b><div class="chip" id="c-${i}" style="display:none">0</div>`;
            div.onclick = () => {
                if (balance >= 100) {
                    balance -= 100; bets[i] += 100;
                    document.getElementById('balance-txt').innerText = "é¤˜é¡: $" + balance;
                    const c = document.getElementById('c-'+i);
                    c.innerText = bets[i]; c.style.display = 'block';
                    log("æŠ•æ³¨: " + s.n);
                }
            };
            board.appendChild(div);
        });
    }

    function setupPeer() {
        if (typeof Peer === 'undefined') {
            log("åš´é‡éŒ¯èª¤: PeerJS æ²’è¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²é€Ÿ");
            return;
        }
        const sid = Math.floor(1000 + Math.random() * 9000);
        peer = new Peer('fpc-' + sid);
        peer.on('open', id => {
            document.getElementById('peer-id').innerText = id.replace('fpc-', '');
            log("é€£ç·šä¼ºæœå™¨å·²å°±ç·’ï¼ŒID: " + id);
        });
        peer.on('connection', c => {
            conn = c;
            log("æ‰‹æ©Ÿå·²é€£ç·šï¼");
            document.getElementById('host-msg').innerText = "ç‹€æ…‹: æ‰‹æ©Ÿå·²é€£ç·š âœ…";
            conn.on('data', data => { if(data === 'ROLL') doRoll(); });
        });
        peer.on('error', e => log("Peer éŒ¯èª¤: " + e.type));
    }

    function doRoll() {
        log("æ”¶åˆ°é–‹éª°æŒ‡ä»¤");
        if (bets.reduce((a, b) => a + b, 0) === 0) {
            log("è­¦å‘Š: æœªä¸‹æ³¨ï¼Œæ‹’çµ•é–‹éª°");
            return;
        }
        document.getElementById('dice-area').innerText = "â³ æ–éª°ä¸­...";
        setTimeout(() => {
            const res = [Math.floor(Math.random()*6), Math.floor(Math.random()*6), Math.floor(Math.random()*6)];
            document.getElementById('dice-area').innerText = symbols[res[0]].i + " " + symbols[res[1]].i + " " + symbols[res[2]].i;
            
            let win = 0, back = 0;
            bets.forEach((bet, i) => {
                const matches = res.filter(r => r === i).length;
                if (matches > 0) { win += bet * matches; back += bet; }
            });
            balance += (win + back);
            bets = [0,0,0,0,0,0];
            document.getElementById('balance-txt').innerText = "é¤˜é¡: $" + balance;
            document.querySelectorAll('.chip').forEach(c => c.style.display = 'none');
            log("é–‹ççµæŸï¼Œè´å¾—: $" + win);
            alert(win > 0 ? "ğŸ‰ è´äº† $" + win : "æ²’ä¸­çï¼");
        }, 1000);
    }

    // --- æ‰‹æ©Ÿé‚è¼¯ ---
    function doConnect() {
        const id = document.getElementById('join-id').value;
        if (!id) return;
        log("å˜—è©¦é€£ç·šåˆ°: " + id);
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('fpc-' + id);
            conn.on('open', () => {
                log("é€£ç·šæˆåŠŸï¼");
                document.getElementById('ctrl-setup').style.display = 'none';
                document.getElementById('ctrl-active').style.display = 'block';
            });
            conn.on('error', e => log("é€£ç·šå¤±æ•—: " + e));
        });
    }

    function sendRoll() {
        if(conn) {
            log("ç™¼é€é–‹éª°è«‹æ±‚...");
            conn.send('ROLL');
        }
    }

    // å•Ÿå‹•ç¢ºèª
    log("App å·²å•Ÿå‹•ï¼Œç­‰å¾…é»æ“Š...");
</script>
</body>
</html>
